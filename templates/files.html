{% extends "base.html" %}

{% block title %}Файлы - {{ settings.PROJECT_NAME }}{% endblock %}

{% block extra_css %}
<style>
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.file-upload-area.dragover {
    border-color: #0d6efd;
    background-color: #e7f3ff;
}

.file-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.file-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.file-thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
}

.file-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    border-radius: 4px;
    font-size: 24px;
    color: #6c757d;
}

.file-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
    flex: 1;
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    text-align: center;
}

.upload-progress {
    height: 4px;
    background-color: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 10px;
}

.upload-progress-bar {
    height: 100%;
    background-color: #0d6efd;
    transition: width 0.3s ease;
}

.file-actions {
    display: flex;
    gap: 5px;
}

.file-actions .btn {
    padding: 4px 8px;
    font-size: 12px;
}

.filter-section {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.image-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.image-preview:hover {
    transform: scale(1.05);
}

.modal-body img {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>
                <i class="bi bi-file-earmark"></i>
                Управление файлами
            </h2>
            <p class="text-muted">Загрузка и управление файлами проектов и задач</p>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <h4 id="total-files">0</h4>
                <small class="text-muted">Всего файлов</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h4 id="total-size">0 MB</h4>
                <small class="text-muted">Общий размер</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h4 id="image-count">0</h4>
                <small class="text-muted">Изображений</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h4 id="document-count">0</h4>
                <small class="text-muted">Документов</small>
            </div>
        </div>
    </div>

    <!-- Загрузка файлов -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-cloud-upload"></i> Загрузка файлов</h5>
                </div>
                <div class="card-body">
                    <div class="file-upload-area" id="fileUploadArea">
                        <i class="bi bi-cloud-upload" style="font-size: 48px; color: #6c757d;"></i>
                        <h5>Перетащите файлы сюда или нажмите для выбора</h5>
                        <p class="text-muted">Максимальный размер: 10MB. Поддерживаемые форматы: JPG, PNG, PDF, DOC, ZIP и другие.</p>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-folder-open"></i> Выбрать файлы
                        </button>
                    </div>

                    <!-- Опции загрузки -->
                    <div class="row mt-3" id="uploadOptions" style="display: none;">
                        <div class="col-md-4">
                            <label for="taskSelect" class="form-label">Привязать к задаче (опционально)</label>
                            <select class="form-select" id="taskSelect">
                                <option value="">Выберите задачу...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="projectSelect" class="form-label">Привязать к проекту (опционально)</label>
                            <select class="form-select" id="projectSelect">
                                <option value="">Выберите проект...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="fileDescription" class="form-label">Описание (опционально)</label>
                            <input type="text" class="form-control" id="fileDescription" placeholder="Введите описание...">
                        </div>
                    </div>

                    <!-- Прогресс загрузки -->
                    <div id="uploadProgress" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Загрузка файлов...</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="upload-progress">
                            <div class="upload-progress-bar" id="progressBar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filterType" class="form-label">Тип файла</label>
                        <select class="form-select" id="filterType">
                            <option value="">Все типы</option>
                            <option value="image">Изображения</option>
                            <option value="document">Документы</option>
                            <option value="video">Видео</option>
                            <option value="audio">Аудио</option>
                            <option value="archive">Архивы</option>
                            <option value="other">Другие</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterProject" class="form-label">Проект</label>
                        <select class="form-select" id="filterProject">
                            <option value="">Все проекты</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterTask" class="form-label">Задача</label>
                        <select class="form-select" id="filterTask">
                            <option value="">Все задачи</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary me-2" onclick="applyFilters()">
                            <i class="bi bi-funnel"></i> Применить
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="bi bi-arrow-clockwise"></i> Сброс
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список файлов -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-folder"></i> Мои файлы</h5>
                    <span class="badge bg-primary" id="fileCount">0 файлов</span>
                </div>
                <div class="card-body">
                    <div id="filesList">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 48px;"></i>
                            <p>Файлы не найдены</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно предпросмотра изображения -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Предпросмотр изображения</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="Предпросмотр">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="#" id="downloadImage" class="btn btn-primary" download>
                    <i class="bi bi-download"></i> Скачать
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFiles = [];
let currentFilters = {};

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    initializeFileUpload();
    loadFiles();
    loadStats();
    loadProjects();
});

// Инициализация загрузки файлов
function initializeFileUpload() {
    const uploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');

    // Клик по области загрузки
    uploadArea.addEventListener('click', function(e) {
        if (e.target.tagName !== 'BUTTON') {
            fileInput.click();
        }
    });

    // Выбор файлов
    fileInput.addEventListener('change', function(e) {
        selectedFiles = Array.from(e.target.files);
        showUploadOptions();
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        selectedFiles = Array.from(e.dataTransfer.files);
        showUploadOptions();
    });
}

// Показать опции загрузки
function showUploadOptions() {
    if (selectedFiles.length > 0) {
        document.getElementById('uploadOptions').style.display = 'block';
    }
}

// Загрузка файлов
async function uploadFiles() {
    if (selectedFiles.length === 0) return;

    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    progressDiv.style.display = 'block';

    const formData = new FormData();
    const taskSelect = document.getElementById('taskSelect');
    const projectSelect = document.getElementById('projectSelect');
    const description = document.getElementById('fileDescription').value;

    selectedFiles.forEach((file, index) => {
        formData.append('files', file);
    });

    if (taskSelect.value) {
        formData.append('task_id', taskSelect.value);
    }

    if (projectSelect.value) {
        formData.append('project_id', projectSelect.value);
    }

    if (description) {
        formData.append('description', description);
    }

    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/v1/files/upload', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            showToast('Файлы успешно загружены', 'success');
            resetUploadForm();
            loadFiles();
            loadStats();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Ошибка загрузки', 'error');
        }
    } catch (error) {
        showToast('Ошибка сети', 'error');
    } finally {
        progressDiv.style.display = 'none';
    }
}

// Сброс формы загрузки
function resetUploadForm() {
    selectedFiles = [];
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadOptions').style.display = 'none';
    document.getElementById('fileDescription').value = '';
    document.getElementById('taskSelect').value = '';
    document.getElementById('projectSelect').value = '';
}

// Загрузка списка файлов
async function loadFiles() {
    try {
        const token = localStorage.getItem('access_token');
        const params = new URLSearchParams(currentFilters);

        const response = await fetch(`/api/v1/files/?${params}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            renderFilesList(data.files);
            document.getElementById('fileCount').textContent = `${data.total} файлов`;
        }
    } catch (error) {
        console.error('Error loading files:', error);
    }
}

// Отрисовка списка файлов
function renderFilesList(files) {
    const filesList = document.getElementById('filesList');

    if (files.length === 0) {
        filesList.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 48px;"></i>
                <p>Файлы не найдены</p>
            </div>
        `;
        return;
    }

    filesList.innerHTML = files.map(file => `
        <div class="file-item">
            <div class="row align-items-center">
                <div class="col-auto">
                    ${file.is_image ?
                        `<img src="/api/v1/files/${file.id}/download" class="file-thumbnail" onclick="previewImage('${file.id}', '${file.original_filename}')" style="cursor: pointer;">` :
                        `<div class="file-icon">
                            <i class="bi bi-file-earmark"></i>
                        </div>`
                    }
                </div>
                <div class="col">
                    <h6 class="mb-1">${file.original_filename}</h6>
                    <p class="mb-1 text-muted">${file.description || 'Нет описания'}</p>
                    <small class="text-muted">
                        ${file.formatted_size} • ${new Date(file.uploaded_at).toLocaleDateString()}
                        ${file.download_count > 0 ? ` • Скачан ${file.download_count} раз` : ''}
                    </small>
                </div>
                <div class="col-auto">
                    <div class="file-actions">
                        <a href="/api/v1/files/${file.id}/download" class="btn btn-sm btn-outline-primary" title="Скачать">
                            <i class="bi bi-download"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-info" onclick="editFile('${file.id}')" title="Редактировать">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.id}')" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Предпросмотр изображения
function previewImage(fileId, filename) {
    const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
    const previewImg = document.getElementById('previewImage');
    const downloadLink = document.getElementById('downloadImage');

    previewImg.src = `/api/v1/files/${fileId}/download`;
    downloadLink.href = `/api/v1/files/${fileId}/download`;
    downloadLink.download = filename;

    modal.show();
}

// Загрузка статистики
async function loadStats() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/v1/files/stats/summary', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const stats = await response.json();
            document.getElementById('total-files').textContent = stats.total_files;
            document.getElementById('total-size').textContent = formatFileSize(stats.total_size);
            document.getElementById('image-count').textContent = stats.type_stats.image?.count || 0;
            document.getElementById('document-count').textContent = stats.type_stats.document?.count || 0;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Загрузка проектов
async function loadProjects() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/v1/projects/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const projects = await response.json();
            const projectSelect = document.getElementById('projectSelect');
            const filterProject = document.getElementById('filterProject');

            const options = '<option value="">Выберите проект...</option>' +
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            projectSelect.innerHTML = options;
            filterProject.innerHTML = '<option value="">Все проекты</option>' +
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

// Применить фильтры
function applyFilters() {
    const filterType = document.getElementById('filterType').value;
    const filterProject = document.getElementById('filterProject').value;
    const filterTask = document.getElementById('filterTask').value;

    currentFilters = {};
    if (filterType) currentFilters.file_type = filterType;
    if (filterProject) currentFilters.project_id = filterProject;
    if (filterTask) currentFilters.task_id = filterTask;

    loadFiles();
}

// Сброс фильтров
function resetFilters() {
    currentFilters = {};
    document.getElementById('filterType').value = '';
    document.getElementById('filterProject').value = '';
    document.getElementById('filterTask').value = '';
    loadFiles();
}

// Удаление файла
async function deleteFile(fileId) {
    if (!confirm('Вы уверены, что хотите удалить этот файл?')) return;

    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/v1/files/${fileId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            showToast('Файл удален', 'success');
            loadFiles();
            loadStats();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Ошибка удаления', 'error');
        }
    } catch (error) {
        showToast('Ошибка сети', 'error');
    }
}

// Форматирование размера файла
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Показать уведомление
function showToast(message, type = 'info') {
    // Простая реализация toast уведомлений
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    toastContainer.innerHTML = toastHtml;
    document.body.appendChild(toastContainer);

    const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
    toast.show();

    setTimeout(() => {
        toastContainer.remove();
    }, 5000);
}
</script>
{% endblock %}
